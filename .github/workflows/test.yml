name: WF Test

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Select device to build"
        required: true
        default: "x86_64"
        type: choice
        options:
          - "armv8"
          - "nanopi-r4s"
          - "nanopi-r5s"
          - "netgear_r8500"
          - "x86_64"
      device_type:
        description: "Device Type"
        required: true
        default: "NUC"
        type: choice
        options:
          - "NUC"
          - "PVE"
      build_options:
        description: "Build options (separate multiple options with spaces)"
        required: false
        default: "BUILD_FAST=y ENABLE_LTO=y ENABLE_MOLD=y ENABLE_LRNG=y ENABLE_BPF=y ENABLE_DPDK=y USE_GCC14=y"
        type: string

jobs:
  build:
    name: Build ${{ github.event.inputs.device }}
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash

    steps:
      - name: Setup variables
        run: |
          export ${{ github.event.inputs.build_options }}
          export DEVTYPE=${{ github.event.inputs.device_type }}
          echo "DEVTYPE=${{ github.event.inputs.device_type }}" >>$GITHUB_ENV
          echo WORKDIR="/builder" >> "$GITHUB_ENV"
          echo ${{ env.DEVTYPE }}
          echo ${{ env.WORKDIR }}
          bash <(curl -sS https://raw.githubusercontent.com/${{ github.repository }}/master/test.sh)
          mkdir -p rom
          echo "test" > /rom/test.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.device }}-openwrt-${{ env.DEVTYPE }}
          path: /rom/*
